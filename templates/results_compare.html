<!DOCTYPE html>
<html lang="en">
<head>
  <title>Threat Attribution Report</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/attribution.css') }}">
  <style>
    h1 { color: #0056b3; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; }
    h3 { margin-top: 2rem; color: #333; }
    pre {
      background: #f3f3f3; padding: 1rem; border-radius: 6px;
      overflow-x: auto; white-space: pre-wrap;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #007bff; color: #fff; }
    a { display: inline-block; color: #007bff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .timestamp { font-size: 0.9rem; color: #666; }
    .divider { margin: 32px 0; border-top: 2px dashed #e0e0e0; }
  </style>
</head>
<body>
  {% if not export_mode %}
  {% include 'common/navbar.html' %}
  {% endif %}

  <div class="container">
    <!-- ========================= Rule-based (top) ========================= -->
    <h1>Threat Attribution Report</h1>
    <p class="timestamp">Generated on: {{ timestamp }}</p>

    <h3>Inputted Techniques</h3>
    <p>{{ ttps | join(', ') }}</p>

    <h3>Top 3 Matched Threat Groups</h3>
    <table>
      {% if rule_matched and rule_matched|length > 0 %}
      <tr>
        {% for col in rule_matched[0].keys() %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
      {% for row in rule_matched %}
      <tr>
        {% for val in row.values() %}
          <td>{{ val }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
      {% else %}
      <tr><td>No matches.</td></tr>
      {% endif %}
    </table>

    <h3>Analyst Report</h3>
    <section>
      <h4>1. Executive Summary</h4>
      <pre>{{ rule_analysis.summary }}</pre>

      <h4>2. Technique Overlap Overview</h4>
      <pre>{{ rule_analysis.table }}</pre>

      <h4>3. Probable Threat Actor(s)</h4>
      <pre>{{ rule_analysis.attacker }}</pre>

      <h4>4. Defensive Mitigations</h4>
      <pre>{{ rule_analysis.mitigation }}</pre>

      <h4>5. Analyst Recommendations</h4>
      <pre>{{ rule_analysis.suggestion }}</pre>
    </section>

    {% if not export_mode %}
    <a href="/">← Back to Selection</a>
    <br>
    <a href="/export?which=rule">Export Results (Rule-based)</a>
    {% endif %}

    <div class="divider"></div>

    <!-- ========================= RoBERTa (below) ========================= -->
    <h1>RoBERTa</h1>
    <p class="timestamp">Generated on: {{ timestamp }}</p>

    <h3>Inputted Techniques</h3>
    <p>{{ ttps | join(', ') }}</p>

    <h3>Top 3 Matched Threat Groups</h3>
    <table>
      {% if rob_matched and rob_matched|length > 0 %}
      <tr>
        {% for col in rob_matched[0].keys() %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
      {% for row in rob_matched %}
      <tr>
        {% for val in row.values() %}
          <td>{{ val }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
      {% else %}
      <tr><td>No matches.</td></tr>
      {% endif %}
    </table>

    <h3>Analyst Report</h3>
    <section>
      <h4>1. Executive Summary</h4>
      <pre>{{ rob_analysis.summary }}</pre>

      <h4>2. Technique Overlap Overview</h4>
      <pre>{{ rob_analysis.table }}</pre>

      <h4>3. Probable Threat Actor(s)</h4>
      <pre>{{ rob_analysis.attacker }}</pre>

      <h4>4. Defensive Mitigations</h4>
      <pre>{{ rob_analysis.mitigation }}</pre>

      <h4>5. Analyst Recommendations</h4>
      <pre>{{ rob_analysis.suggestion }}</pre>
    </section>

    {% if not export_mode %}
    <a href="/">← Back to Selection</a>
    <br>
    <a href="/export?which=roberta">Export Results (RoBERTa)</a>
    {% endif %}
  </div>
</body>
</html>
